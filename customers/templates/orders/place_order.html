{% extends 'base.html' %}

{% block content %}
<style>
  .quantity-input {
    font-size: 1.25rem;
    padding: 0.5rem 0.75rem;
  }
  .price-badge {
    font-size: 1.25rem;
    padding: 0.5em 0.75em;
  }
  .order-summary {
    margin-top: 1rem;
  }
  .order-summary .total-input {
    width: 150px;
    text-align: right;
    font-weight: bold;
    padding: 0.375rem 0.75rem;
  }
  .action-buttons {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
  }
</style>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Cake Shop Inventory Management System</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'product_list' %}">Products</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'place_order' %}">Orders</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'orders_report' %}">Orders Report</a></li>
        <li class="nav-item">
          {% if user.is_superuser %}
              <a class="nav-link" href="{% url 'profit_loss' %}">Profit & Loss</a>
          {% endif %}
        </li>
        <li class="nav-item"><a class="nav-link" href="{% url 'feedback' %}">Feedbacks</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'suppliers_page' %}">Suppliers</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container mt-5">
    <h1 class="text-center mb-4">Place Order</h1>

    <!-- SEARCH BAR: a GET form (server-side) + live client-side filtering -->
    <form id="searchForm" method="get" class="mb-3">
      <div class="input-group">
        <input
          type="search"
          name="q"
          id="searchInput"
          class="form-control"
          placeholder="Search products by name..."
          value="{{ query|default:'' }}"
          aria-label="Search products"
        >
        <button class="btn btn-outline-secondary" type="submit">Search</button>
        <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">Clear</button>
      </div>
    </form>

    <form id="orderForm" method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" id="actionField" value="">

      <div class="mb-4">
        <label class="form-label">Choose Products and Quantity</label>
        <ul class="list-group" id="productList">
          {% for product in products %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="w-50">
                <div class="form-check">
                  <input class="form-check-input product-checkbox" type="checkbox" name="products" value="{{ product.id }}" id="prod_{{ product.id }}">
                  <label class="form-check-label product-label" for="prod_{{ product.id }}">{{ product.name }} (In stock: {{ product.stock }})</label>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <input type="number" name="quantity_{{ product.id }}" class="form-control form-control-sm me-2 quantity-input" value="1" min="1" max="{{ product.stock }}" disabled>
                <span class="price-badge badge bg-primary rounded-pill fs-5">Kshs {{ product.price }}</span>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>

      <div class="order-summary">
        <label class="form-label" for="totalField">Total Amount</label>
        <input type="text" id="totalField" class="total-input" readonly>
        <div class="action-buttons">
          <button type="button" id="calculateBtn" class="btn btn-secondary">Calculate</button>
          <button type="button" id="saveBtn" class="btn btn-success" disabled>Save</button>
          <button type="button" id="printBtn" class="btn btn-primary" disabled>Print Receipt</button>
          <button type="button" id="clearBtn" class="btn btn-warning">Clear</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const orderForm = document.getElementById('orderForm');
  const actionField = document.getElementById('actionField');
  const totalField = document.getElementById('totalField');
  const saveBtn = document.getElementById('saveBtn');
  const printBtn = document.getElementById('printBtn');
  const clearBtn = document.getElementById('clearBtn');
  const calculateBtn = document.getElementById('calculateBtn');
  const productListItems = Array.from(document.querySelectorAll('#productList li'));

  // Search controls
  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearchBtn');

  // Safety: if product list is empty, nothing to do
  if (!productListItems.length) {
    console.warn('product list is empty or selector changed (#productList li).');
  }

  // Initialize data-price attribute for each product price badge
  productListItems.forEach(li => {
    const priceBadge = li.querySelector('.price-badge');
    if (!priceBadge) return;
    const raw = priceBadge.textContent.replace(/[^0-9.]/g, '');
    priceBadge.dataset.price = raw || '0';
  });

  // Toggle quantity inputs when checkbox toggled
  productListItems.forEach(li => {
    const cb = li.querySelector('.product-checkbox');
    const qtyInput = li.querySelector('.quantity-input');
    if (!cb || !qtyInput) return;
    cb.addEventListener('change', () => {
      qtyInput.disabled = !cb.checked;
      if (!cb.checked) qtyInput.value = 1;
    });
  });

  // Helper to get label text for a list item (fallbacks to li text)
  function getLabelText(li) {
    const labelEl = li.querySelector('.product-label') || li.querySelector('.form-check-label');
    if (labelEl && labelEl.textContent) return labelEl.textContent.toLowerCase();
    return li.textContent.toLowerCase();
  }

  // Live filter function (term is already trimmed)
  function filterProductsLive(term) {
    const q = (term || '').toLowerCase().trim();
    productListItems.forEach(li => {
      const label = getLabelText(li);
      const show = !q || label.indexOf(q) !== -1;
      li.style.display = show ? '' : 'none';

      // keep state consistent when hidden
      const cb = li.querySelector('.product-checkbox');
      const qtyInput = li.querySelector('.quantity-input');
      if (cb && qtyInput) {
        if (!show) {
          cb.checked = false;
          qtyInput.value = 1;
          qtyInput.disabled = true;
        } else {
          qtyInput.disabled = !cb.checked;
        }
      }
    });
  }

  // live filter on typing (still allows Enter to submit the GET search)
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      try {
        filterProductsLive(e.target.value);
      } catch (err) {
        console.error('Error during live filtering:', err);
      }
    });

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      // If you want the server-side results cleared too, uncomment:
      // document.getElementById('searchForm').submit();
      window.location.href = window.location.pathname;
      filterProductsLive('');
    });
  } else {
    console.warn('searchInput element not found. Server-side search still works on submit.');
  }

  // Calculate total with selection validation (only on visible rows)
  calculateBtn.addEventListener('click', () => {
    // Use computed style to check visibility
    const visibleItems = productListItems.filter(li => getComputedStyle(li).display !== 'none');
    const selectedBoxes = visibleItems.filter(li => li.querySelector('.product-checkbox').checked);
    if (selectedBoxes.length === 0) {
      alert('Please select at least one product to calculate.');
      return;
    }
    let total = 0;
    for (const li of selectedBoxes) {
      const cb = li.querySelector('.product-checkbox');
      const id = cb.value;
      const qty = Number(li.querySelector(`input[name=quantity_${id}]`).value) || 0;
      const price = parseFloat(li.querySelector('.price-badge').dataset.price) || 0;
      if (qty < 1) { alert('Quantity must be at least 1'); return; }
      total += qty * price;
    }
    totalField.value = 'Kshs ' + total.toFixed(2);
    saveBtn.disabled = false;
    printBtn.disabled = false;
  });

  // Save action -> prevent double submit
  saveBtn.addEventListener('click', (e) => {
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    actionField.value = 'save';
    orderForm.submit();
  });

  // Print action -> disable & submit
  printBtn.addEventListener('click', (e) => {
    printBtn.disabled = true;
    actionField.value = 'print';
    orderForm.submit();
  });

  // Clear everything
  clearBtn.addEventListener('click', () => {
    totalField.value = '';
    saveBtn.disabled = true;
    printBtn.disabled = true;
    productListItems.forEach(li => {
      const cb = li.querySelector('.product-checkbox');
      const qtyInput = li.querySelector('.quantity-input');
      if (cb) cb.checked = false;
      if (qtyInput) {
        qtyInput.disabled = true;
        qtyInput.value = 1;
      }
      li.style.display = '';
    });
    if (searchInput) {
      searchInput.value = '';
      filterProductsLive('');
    }
  });

  // If the server passed a query value, apply it on load
  if (searchInput && searchInput.value) {
    filterProductsLive(searchInput.value);
  }

  // Helpful debug hint in console
  console.info('Product list filter initialized â€” items:', productListItems.length);
});
</script>


{% endblock %}
